---
title: "Clean analysis"
author: "Siim"
date: "2/10/2021"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo = FALSE, warning = FALSE, message = FALSE}
library("readxl")
library("tidyverse")
library("gmodels")
library("vcd")
library("vcdExtra")
library("ggplot2")
library("graphics")
library("lmtest")
library(stats)
```

```{r echo = FALSE, warning = FALSE, message = FALSE}
#Path fodleris
path <- "main_data.xlsx"

#Nii loeme sisse erinevad exceli faili alasheetid
heidi_xl <- path %>% 
  excel_sheets() %>% 
  set_names() %>% 
  map(read_excel, path = path)

#Kõik alasheetid omaette df-ideks
estlines <- as.data.frame(heidi_xl["Estonian Headlines"])
ruslines <- as.data.frame(heidi_xl["Russian Headlines"])
uslines <- as.data.frame(heidi_xl["US Headlines"])

#Kõigile alasheetidele uus tulp, mis väljendab riiki
estlines <- cbind(estlines, c(rep("est", nrow(estlines))))
ruslines <- cbind(ruslines, c(rep("rus", nrow(ruslines))))
uslines <- cbind(uslines, c(rep("us", nrow(uslines))))

#Uuele tulbale nimi
colnames(estlines)[14] <- c("country")
colnames(ruslines)[14] <- c("country")
colnames(uslines)[14] <- c("country")

#Kui tulbanimes 1 või rohkem ükskõik, millist tähte koos kriipsuga, siis asendada
colnames(estlines) <- gsub(".*\\.", "", colnames(estlines))
colnames(ruslines) <- gsub(".*\\.", "", colnames(ruslines))
colnames(uslines) <- gsub(".*\\.", "", colnames(uslines))
colnames(ruslines)[8] <- c("Issue")

#Kõik df-id üheks
allines <- rbind(estlines, ruslines, uslines)

#Tulbanimede vahetus
colnames(allines) <- c("Date", "Headline", "Clicked_headline", "Image", "Translation", "Outlate_name", "Outlet_code", 
                        "Issue", "Them_Ep", "Frame_code", "Frame_notes", "Isrep", "Notes", "Country")

#Eraldi tulp, kus kirjas kas artikkel on ühe frame kodeeringuga (TRUE FALSE)
allines <- allines %>% 
  mutate(single_frame = grepl("^([a-z]{1})$", allines$Frame_code))

#Eraldi tulp, kus kirjas kas artikkel on ühe issue kodeeringuga (TRUE FALSE)
allines <- allines %>% 
  mutate(single_issue = grepl("^([a-z]{1})$", allines$Issue))

```

### Country and representativeness
```{r echo = FALSE, warning = FALSE}
Cnt_ir <- allines %>% 
  select(Country, Isrep) %>% 
  mutate(Isrep = recode(Isrep, `2` = "not representative", `1` = "representative")) %>% 
  drop_na()
```

The chi-squared test shows us that country and representativeness are associated $\chi^2(2, n=784)=9.40, p < .05$ Looking at the standardized residuals we can see that the biggest deviance (-2.28) comes from Estonian articles being unrepresentative a lot **less** than could be expected under independence of country and representativeness. The standardized residuals in Russia (1.33, -0.58)  and US (0.93, -0.41) seem to be pretty much similar with articles in both countries being unrepresentative slightly more times than could be expected but not smuch more. Russias and US contribution to the chi-squared statistic is small and most of the deviance from independence seems to come from Estonia.
```{r echo = FALSE, eval = FALSE}
CrossTable(Cnt_ir$Country, Cnt_ir$Isrep, chisq = TRUE, expected = TRUE, sresid = TRUE, format = "SPSS")
```

```{r echo = FALSE}
mosaicplot(table(Cnt_ir$Country, Cnt_ir$Isrep), shade = TRUE, las=2,
           main = "Article representativeness", xlab = "Country", ylab = "Representativeness"
           )
```

### Framing of Issues in the countries

162 articles, that is 162/800 = 20.25% are articles with multiple "issues" and/or multiple "frames". Since here the object of study is "the article" and not the variable or coding itself, multiple codings will be reduced to a single "main code" for each article for the sake of the independence requirement (between the categories) of our analysis. Further research could be done to investigate the multiple codings themselves. For example the relationship between issues within articles and wether some issues (or) are more likely to be together than others.

We consolidated issues a, c, f, i, k into the category "Other", 8 articles were excluded because in 4 cases framing was "unclear" and in 4 cases issue was not coded.
```{r echo = FALSE, warning = FALSE}
Cnt_fr_is <- allines %>%
  mutate(id = row_number()) %>% #Lisan igale artiklile unique id
  select(id, Country, Frame_code, Issue) %>% # vajalikud tulbad
  separate(Frame_code, c("Frame1", "Frame2", "Frame3")) %>% # lahutan mitme kodeeringuga erinevateks tulpadeks
  select(id, Country, Frame1, Issue) %>% 
  mutate(Frame1 = recode(Frame1, i="d")) %>% 
  filter(Frame1 != c("Unclear")) %>% #Neid ei taha
    separate(Issue, c("Issue1", "Issue2", "Issue3", "Issue4")) %>% #Sama, mis frame'idega issuede jaoks
    select(id, Country, Frame1, Issue1) %>% 
    mutate(Issue1 = recode(Issue1, D = "d")) %>% # D on tegelt d
  mutate(Issue1 = recode(Issue1, a = "Other", c = "Other", f = "Other", i = "Other", k = "Other", I = "Other")) %>%
    drop_na() %>% #Kõik na-d maha (tekkisid sellepärast, et erinev arv kodeeringuid artiklitel)
  rename(Frame = Frame1, Issue = Issue1)
```

Heres a view for good in country comparison of different framings within issue
```{r echo = FALSE, message = FALSE, fig.dim= c(12,10)}
Cnt_fr_is %>% 
  group_by(Country, Issue, Frame) %>% 
  count() %>% 
  mutate(Frame = recode(Frame, a = "Attribution of responsibility", b = "Conflict", c = "Economic",
                        d = "Human interest", e = "Morality")) %>% 
  mutate(Issue = recode(Issue, b = "Issue: Local Elections/politics", d = "Issue: Ukraine", e = "Issue: Social Welfare",
                      g = "Issue: Military", h = "Issue: Public Health and Safety", j = "Issue: International Relations")) %>%
  ungroup() %>% 
  group_by(Country, Issue) %>% 
  mutate(pct = paste0("(",round((n/sum(n))*100,0),"%)*")) %>% 
  ggplot(., aes(x = Country, y = n)) + 
  ggtitle("Framing of issues in Estonia, Russia, and the US") +
  theme(legend.position = "bottom")+
  geom_bar(aes(fill = Frame), stat = "identity", position = "dodge", width = 0.8) +
  geom_text(aes(x = Country, y = n, label = paste0(n, "\n", pct), group = Frame), 
            position = position_dodge(width = 0.9), vjust = -0.5, size = 2)+
  expand_limits(y = c(0, 33))+
  annotate("text", x = 1.3, y = 30, label = "*% of issue in country", size = 2.5, color = "red")+
  facet_wrap(~ Issue) +
  ggsave("cnt_fr_is_bars.png", dpi= 350)
```

Heres another view to better compare framings between countries
```{r echo = FALSE, fig.dim= c(12,10)}
pcts2 <- Cnt_fr_is %>%
  group_by(Country, Issue, Frame) %>% 
  mutate(Frame = recode(Frame, a = "Attribution of responsibility", b = "Conflict", c = "Economic",
                        d = "Human interest", e = "Morality")) %>% 
  mutate(Issue = recode(Issue, b = "Issue: Local Elections/politics", d = "Issue: Ukraine", e = "Issue: Social Welfare",
                      g = "Issue: Military", h = "Issue: Public Health and Safety", j = "Issue: International Relations")) %>% 
  count() %>%
  ungroup() %>%
  group_by(Country, Issue) %>% 
  mutate(pct = paste0(round((n/sum(n))*100,0),"%"))

Cnt_fr_is %>%
  mutate(Frame = recode(Frame, a = "Attribution of responsibility", b = "Conflict", c = "Economic",
                        d = "Human interest", e = "Morality")) %>% 
  mutate(Issue = recode(Issue, b = "Issue: Local Elections/politics", d = "Issue: Ukraine", e = "Issue: Social Welfare",
                      g = "Issue: Military", h = "Issue: Public Health and Safety", j = "Issue: International Relations")) %>% 
  right_join(., pcts2, by = c("Country"="Country", "Issue"="Issue", "Frame"="Frame")) %>% 
  ggplot(., aes(x = Country, fill = Frame)) + 
  ggtitle("Framing of issues in Estonia, Russia, and the US") +
  theme(legend.position = "bottom") +
  ylab("Percentage")+
  geom_bar(position = "fill", width = 0.8) +
  stat_count(geom = "text", 
             aes(label = paste0(pct)),
             position=position_fill(vjust=0.3), colour="black")+
  facet_wrap(~ Issue) 
```

A chi-squared test ignoring issues shows us that **Country and Framing are not associated** with $\chi^2(8, n=629)=11.208, p = .12$. That suggests that Framing is independent of the country where the news are published. Looking at the standardized residuals we see that most of them are between 2 and -2.
```{r echo = FALSE}
Cnt_fr <- Cnt_fr_is %>% 
  select(id, Country, Frame)
chisq.test(Cnt_fr$Country, Cnt_fr$Frame)

mosaicplot(table(Cnt_fr$Country, Cnt_fr$Frame), shade = TRUE, las=2,
           main = "Relationship of framing with country", xlab = "Country", ylab = "Frame"
           )
```

```{r eval = FALSE, echo = FALSE}
CrossTable(Cnt_fr$Country, Cnt_fr$Frame, chisq = TRUE, expected = TRUE, sresid = TRUE, format = "SPSS")
```

Looking at the relationship between issue and framing (ignoring country alltogether) we can se a strong relationship $\chi^2(20, n=629)=95.45, p < .001$. As expected framing and issue are strongly related. Looking at the standardized residuals we can see that "Local Eelctions/Politics" is framed much less as "economic" than would be expected under independence; also that "Social welfare" is framed as "conflict" much less and much more as "Economic" (that also being the biggest contributor to the chi squared statistic) than would be expected if issue and frame had no relationship. Also that Public health and safety issue is framed considerably more as "Human Interest" than would be expected under independence. The category Other is overwhelmingly framed as "Human interest" qway more than would be expected under independence.
```{r echo = FALSE}
Is_fr <- Cnt_fr_is %>% 
  select(id, Issue, Frame)

chisq.test(Is_fr$Issue, Is_fr$Frame)

mosaicplot(table(Is_fr$Issue, Is_fr$Frame), shade = TRUE, las=2,
           main = "Relationship of framing with Issue", xlab = "Issue", ylab = "Frame"
           )
```

```{r eval = FALSE, echo = FALSE}
CrossTable(Is_fr$Issue, Is_fr$Frame, chisq = TRUE, expected = TRUE, sresid = TRUE, format = "SPSS")
```

Looking at the relationship between country and Issue (ignoring framing) we can see that country and issue are very strongy related at $\chi^2(10, n=629)=172.9, p < .001$. Telling us that Issues reported are dependent on the country. Looking at the standardized residuals we can see that in each country there are issues that get reported less or more than could be expected when issue would have no relationship with country. We can see that in Estonia issues b and e are reported more than expected and issues d and j get reported less then epected. In russia issue d gets reported more than expected and issue b gets reported significantly less. In the US issues d and e are reported a lot less than expected and j is reported more. We can see that issues reported in different countries differ a lot. And all the countries are very different in what issues they report more or less than would be expected under independence. There is no apparent similarity between any two countries.
```{r echo = FALSE}
Cnt_is <- Cnt_fr_is %>% 
  select(id, Country, Issue)

chisq.test(Cnt_is$Country, Cnt_is$Issue)

mosaicplot(table(Cnt_is$Country, Cnt_is$Issue), shade = TRUE, las=2,
           main = "Relationship of Issue with country", xlab = "Country", ylab = "Issue"
           )
```

```{r eval = FALSE, echo =FALSE}
CrossTable(Cnt_is$Country, Cnt_is$Issue, chisq = TRUE, expected = TRUE, sresid = TRUE, format = "SPSS")
```

Next we will build a hierarchical log-linear model to assess the relationship between variables and their interactions with the cell counts in the three-way contingency table. The significant likelihood-ratio test and the AIC show us that we can't remove any of the two-way interactions from the model. That means all the relationships between variables differ on different levels of the other variables. This in turn tells us is that the relationship between Country and Frame which is not significant ignoring Issue, is signficant when we take different Issues into account. So the relationship between country and framing changes between Issues. 
```{r echo = FALSE, eval = FALSE}
Cfi_n <- Cnt_fr_is %>% 
  select(Country, Issue, Frame) %>% 
  mutate(Country = factor(Country, levels = c("rus", "us", "est"))) %>% 
  mutate(Issue = factor(Issue)) %>% 
  mutate(Frame = factor(Frame)) %>% 
  group_by(Country, Issue, Frame, .drop=FALSE) %>% 
  count() %>% 
  ungroup()

fit <- glm(n ~ Country + Issue + Frame +  Issue:Frame + Issue:Country + Frame:Country, family=poisson, data=Cfi_n)
fit2<- glm(n ~ Country + Issue + Frame +  Issue:Frame + Issue:Country, family=poisson, data=Cfi_n)

lrtest(fit, fit2)

summary(fit)
summary(fit2)
```

Looking at individual fisher exact tests (because of many cells counts under 5) we can see that at .05 alpha level country and framing have a significant relationship in the issue (or collection of issues) coded as "Other" p = .003.  An alpha level of .1 could also be concidered appropriate  with low counts as we have and with that the issues of "International relations" p = 0.051 and  "Social Welfare" p = 0.051 would also be significant, but after correcting for multiple testing this effect becomes insignificant.

All other issues show stronger evidence for no relationship between country and framing, meaning it is likley that countries don't frame these issues significantly differently in the population. 
```{r echo = FALSE, eval = FALSE}
Cfb <- Cnt_fr_is %>% 
  filter(Issue == "b") 
Cfd <- Cnt_fr_is %>% 
  filter(Issue == "d")
Cfe <- Cnt_fr_is %>% 
  filter(Issue == "e") 
Cfg <- Cnt_fr_is %>% 
  filter(Issue == "g") 
Cfh <- Cnt_fr_is %>% 
  filter(Issue == "h") 
Cfj <- Cnt_fr_is %>% 
  filter(Issue == "j") 
Cfo <- Cnt_fr_is %>% 
  filter(Issue == "Other") 

bfish <- fisher.test(Cfb$Country, Cfb$Frame, workspace = 2e9)
dfish <- fisher.test(Cfd$Country, Cfd$Frame, workspace = 2e9)
efish <- fisher.test(Cfe$Country, Cfe$Frame, workspace = 2e9)
gfish <- fisher.test(Cfg$Country, Cfg$Frame, workspace = 2e9)
hfish <- fisher.test(Cfh$Country, Cfh$Frame, workspace = 2e9)
jfish <- fisher.test(Cfj$Country, Cfj$Frame, workspace = 2e9)
ofish <- fisher.test(Cfo$Country, Cfo$Frame, workspace = 2e9)


mosaicplot(table(Cfb$Country, Cfb$Frame), shade = TRUE, las=2,
           main = "Relationship of country and frame in Local Elections/politics", xlab = "Country", ylab = "Frame"
           )
mosaicplot(table(Cfd$Country, Cfd$Frame), shade = TRUE, las=2,
           main = "Relationship of country and frame in Ukraine", xlab = "Country", ylab = "Frame"
           )
mosaicplot(table(Cfg$Country, Cfg$Frame), shade = TRUE, las=2,
           main = "Relationship of country and frame in Military", xlab = "Country", ylab = "Frame"
           )
mosaicplot(table(Cfh$Country, Cfh$Frame), shade = TRUE, las=2,
           main = "Relationship of country and frame in Public Healthand safety", xlab = "Country", ylab = "Frame"
           )
```

```{r echo = FALSE, eval = FALSE}
CrossTable(Cfe$Country, Cfe$Frame, chisq = TRUE, expected = TRUE, sresid = TRUE, format = "SPSS")

fisher.test(Cfe$Country, Cfe$Frame, workspace = 2e9)

mosaicplot(table(Cfe$Country, Cfe$Frame), shade = TRUE, las=2,
           main = "Relationship of country and frame in Social Welfare", xlab = "Country", ylab = "Frame"
           )
```

```{r echo = FALSE, eval = FALSE}
CrossTable(Cfo$Country, Cfo$Frame, chisq = TRUE, expected = TRUE, sresid = TRUE, format = "SPSS")

mosaicplot(table(Cfo$Country, Cfo$Frame), shade = TRUE, las=2,
           main = "Relationship of country and frame in Other", xlab = "Country", ylab = "Frame"
           )
fisher.test(Cfo$Country, Cfo$Frame, workspace = 2e9)
```

```{r echo = FALSE, eval = FALSE}
CrossTable(Cfj$Country, Cfj$Frame, chisq = TRUE, expected = TRUE, sresid = TRUE, format = "SPSS")

mosaicplot(table(Cfj$Country, Cfj$Frame), shade = TRUE, las=2,
           main = "Relationship of country and frame in International relations", xlab = "Country", ylab = "Frame"
           )

fisher.test(Cfj$Country, Cfj$Frame, workspace = 2e9)
```

Looking at these graphs again we can see that within "International relations" the biggest deviance from expected values comes from Estonia framing it conciderably more as "Human Interest" and less as "Economic" or "Conflict". In "Social Welfare" the US used the "Economic" framing more "Human Interest" not at all and Estonia used "Human interest" much more than could be expected under independence. Looking at the category "Other" we can see that in Estonia most of these articles are framed as "Human Interest" while in Russia "Economic" and "Attribution of responsibility" is used in these issues under "Other". The differences are quite visible but in the cases of international relations and social welfare their statistical significance is under question. Most of the significant differences between countries in framing comes from the category "Other"
```{r echo=FALSE}
pcts <- Cnt_fr_is %>%
  filter(Issue == "e" | Issue == "j" | Issue == "Other") %>% 
  group_by(Country, Issue, Frame) %>% 
  mutate(Frame = recode(Frame, a = "Attribution of responsibility", b = "Conflict", c = "Economic",
                        d = "Human interest", e = "Morality")) %>% 
  mutate(Issue = recode(Issue, e = "Issue: Social Welfare", j = "Issue: International Relations")) %>% 
  count() %>%
  ungroup() %>%
  group_by(Country, Issue) %>% 
  mutate(pct = paste0(round((n/sum(n))*100,0),"%"))

Cnt_fr_is %>%
  filter(Issue == "e" | Issue == "j" | Issue == "Other") %>% 
  mutate(Frame = recode(Frame, a = "Attribution of responsibility", b = "Conflict", c = "Economic",
                        d = "Human interest", e = "Morality")) %>% 
  mutate(Issue = recode(Issue, e = "Issue: Social Welfare", j = "Issue: International Relations")) %>% 
  right_join(., pcts, by = c("Country"="Country", "Issue"="Issue", "Frame"="Frame")) %>% 
  ggplot(., aes(x = Country, fill = Frame)) + 
  ggtitle("Framing of issues in Estonia, Russia, and the US") +
  theme(legend.position = "bottom") +
  ylab("Percentage")+
  geom_bar(position = "fill", width = 0.8) +
  stat_count(geom = "text", 
             aes(label = paste0(pct)),
             position=position_fill(vjust=0.3), colour="black")+
  facet_wrap(~ Issue) +
  ggsave("cnt_fr_is_stack.png", dpi= 350)
```

